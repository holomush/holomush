# Phase 1.5 Design: Infrastructure & Process Separation

**Status:** Archived (superseded by roadmap)
**Date:** 2026-01-17
**Version:** 1.0.0

## Overview

Phase 1.5 refactors HoloMUSH into a two-process architecture with proper CLI, structured logging, and observability. This enables hot-reload of the core without disconnecting clients.

### Scope

**In scope:**

- Cobra CLI with subcommands (`gateway`, `core`, `migrate`, lifecycle commands)
- Process separation: Gateway (protocol servers) and Core (engine, plugins, eventing)
- gRPC over mTLS (TCP localhost) for Gateway↔Core communication
- Auto-generated self-signed TLS certificates with game_id in SAN
- Structured JSON logging with configurable format (JSON/text)
- OpenTelemetry tracing with trace context in logs
- XDG Base Directory spec for file locations
- Control sockets for lifecycle management and health endpoints
- Documentation updates

**Out of scope:**

- Web server implementation (architecture slot only)
- Config file support (flags + env vars only for now)
- Remote core deployment (localhost only)
- Authentication/users (Phase 2)

## Success Criteria

1. `holomush core` starts, listens on gRPC/TLS, logs in JSON format
2. `holomush gateway` starts, connects to core, accepts telnet clients
3. Restart core while gateway running - clients stay connected, gateway reconnects
4. `holomush core stop` / `holomush gateway stop` gracefully shutdown via control socket
5. `holomush status` shows health of both processes
6. Auto-generated mTLS certs on first run, stored in XDG paths
7. Gateway rejects core with wrong `game_id` in certificate SAN
8. All logs include `trace_id` and `span_id` when OTEL context present
9. `--log-format=text` produces human-readable output for development
10. `--otlp-endpoint` enables trace export to collector
11. Documentation updated to reflect new architecture and CLI

## Architecture

### Process Model

Single binary (`holomush`), two process types:

```text
┌─────────────────────────────────────────────────────────────────┐
│                         holomush gateway                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Telnet    │  │    Web      │  │   Control Socket        │  │
│  │   Server    │  │   Server    │  │   (lifecycle, health)   │  │
│  └──────┬──────┘  └──────┬──────┘  └─────────────────────────┘  │
│         │                │                                       │
│         └───────┬────────┘                                       │
│                 │                                                │
│         ┌───────▼────────┐                                       │
│         │  gRPC Client   │                                       │
│         │  (TLS, reconnect)                                      │
│         └───────┬────────┘                                       │
└─────────────────┼───────────────────────────────────────────────┘
                  │ gRPC/mTLS (localhost:port)
┌─────────────────┼───────────────────────────────────────────────┐
│         ┌───────▼────────┐                      holomush core    │
│         │  gRPC Server   │                                       │
│         │  (TLS)         │                                       │
│         └───────┬────────┘                                       │
│                 │                                                │
│  ┌──────────────┼──────────────┐                                 │
│  │              │              │                                 │
│  ▼              ▼              ▼                                 │
│ ┌────────┐ ┌──────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│ │ Engine │ │Broadcaster│ │ Plugin Host │ │   Control Socket    │ │
│ └────────┘ └──────────┘ └─────────────┘ │   (lifecycle, health)│ │
│                                          └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

**Key points:**

- Gateway holds client connections, survives core restarts
- Gateway's gRPC client auto-reconnects when core comes back
- Both processes have independent control sockets
- Same binary, different subcommands, independent processes

### Component Responsibilities

| Component | Responsibilities                                                       | Database Access |
| --------- | ---------------------------------------------------------------------- | --------------- |
| Gateway   | Protocol servers (telnet, web), client connections, command forwarding | None            |
| Core      | Engine, eventing, plugins, sessions, game logic                        | PostgreSQL      |

## CLI Commands

| Command                    | Description                      |
| -------------------------- | -------------------------------- |
| `holomush gateway`         | Start gateway (protocol servers) |
| `holomush gateway stop`    | Stop running gateway             |
| `holomush gateway restart` | Restart gateway                  |
| `holomush gateway status`  | Show gateway health/metrics      |
| `holomush core`            | Start core (engine, plugins)     |
| `holomush core stop`       | Stop running core                |
| `holomush core restart`    | Restart core                     |
| `holomush core reload`     | Hot-reload plugins (future)      |
| `holomush core status`     | Show core health/metrics         |
| `holomush migrate`         | Run database migrations (future) |
| `holomush status`          | Show health of all components    |

### Common Flags

| Flag              | Description                  | Default                  |
| ----------------- | ---------------------------- | ------------------------ |
| `--log-format`    | Log format: `json` or `text` | `json`                   |
| `--otlp-endpoint` | OTLP collector endpoint      | (disabled)               |
| `--config-dir`    | Override config directory    | XDG_CONFIG_HOME/holomush |
| `--data-dir`      | Override data directory      | XDG_DATA_HOME/holomush   |

### Gateway-specific Flags

| Flag            | Description                          | Default          |
| --------------- | ------------------------------------ | ---------------- |
| `--telnet-addr` | Telnet listen address                | `:4201`          |
| `--core-addr`   | Core gRPC address                    | `localhost:9000` |
| `--game-id`     | Expected game_id for cert validation | (from config)    |

### Core-specific Flags

| Flag             | Description                  | Default          |
| ---------------- | ---------------------------- | ---------------- |
| `--grpc-addr`    | gRPC listen address          | `localhost:9000` |
| `--database-url` | PostgreSQL connection string | (required)       |

## gRPC Service Contract

```protobuf
syntax = "proto3";
package holomush.core.v1;

import "google/protobuf/timestamp.proto";

// Request/response metadata for correlation and debugging
message RequestMeta {
  string request_id = 1;                    // ULID, for log correlation
  google.protobuf.Timestamp timestamp = 2;
}

message ResponseMeta {
  string request_id = 1;                    // Echo back
  google.protobuf.Timestamp timestamp = 2;
}

service Core {
  rpc Authenticate(AuthRequest) returns (AuthResponse);
  rpc HandleCommand(CommandRequest) returns (CommandResponse);
  rpc Subscribe(SubscribeRequest) returns (stream Event);
  rpc Disconnect(DisconnectRequest) returns (DisconnectResponse);
}

message AuthRequest {
  RequestMeta meta = 1;
  string username = 2;
  string password = 3;
}

message AuthResponse {
  ResponseMeta meta = 1;
  bool success = 2;
  string session_id = 3;
  string character_id = 4;
  string character_name = 5;
  string error = 6;
}

message CommandRequest {
  RequestMeta meta = 1;
  string session_id = 2;
  string command = 3;
}

message CommandResponse {
  ResponseMeta meta = 1;
  bool success = 2;
  string output = 3;
  string error = 4;
}

message SubscribeRequest {
  RequestMeta meta = 1;
  string session_id = 2;
  repeated string streams = 3;
}

message Event {
  string id = 1;
  string stream = 2;
  string type = 3;
  google.protobuf.Timestamp timestamp = 4;
  string actor_type = 5;
  string actor_id = 6;
  bytes payload = 7;
}

message DisconnectRequest {
  RequestMeta meta = 1;
  string session_id = 2;
}

message DisconnectResponse {
  ResponseMeta meta = 1;
  bool success = 2;
}
```

### OpenTelemetry Integration

- Use `go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc` interceptors
- Trace context propagated automatically via gRPC metadata/baggage
- Both gateway and core register OTEL interceptors
- `--otlp-endpoint` flag enables trace export (disabled by default)

## File Locations (XDG)

Implementation MUST check environment variables first, then fall back to defaults.

| XDG Variable      | Default          | HoloMUSH Usage    |
| ----------------- | ---------------- | ----------------- |
| `XDG_CONFIG_HOME` | `~/.config`      | Config, TLS certs |
| `XDG_DATA_HOME`   | `~/.local/share` | Persistent data   |
| `XDG_STATE_HOME`  | `~/.local/state` | Logs, PID files   |
| `XDG_RUNTIME_DIR` | `/run/user/$UID` | Control sockets   |

### Directory Structure

```text
$XDG_CONFIG_HOME/holomush/
├── gateway.yaml         # Gateway config (game_id, core_addr, etc.)
└── certs/
    ├── root-ca.crt      # Root CA certificate (shared)
    ├── root-ca.key      # Root CA private key (protect!)
    ├── core.crt         # Core server cert (signed by root)
    ├── core.key         # Core server private key
    ├── gateway.crt      # Gateway client cert (signed by root)
    └── gateway.key      # Gateway client private key

$XDG_DATA_HOME/holomush/
└── (future: plugin data, etc.)

$XDG_STATE_HOME/holomush/
├── core.pid
├── gateway.pid
└── logs/
    ├── core.log
    └── gateway.log

$XDG_RUNTIME_DIR/holomush/
├── core.sock            # Control socket
└── gateway.sock         # Control socket
```

### Fallbacks

- If `XDG_RUNTIME_DIR` unset: Fall back to `$XDG_STATE_HOME/holomush/run/`

## TLS Certificate Management

### Certificate Hierarchy

```text
Root CA (self-signed)
├── Core certificate (server)
│   └── SAN: localhost, 127.0.0.1, holomush-<game_id>
└── Gateway certificate (client)
    └── CN: holomush-gateway
```

### mTLS Validation Rules

| Validator        | Validates             | Checks                                                            |
| ---------------- | --------------------- | ----------------------------------------------------------------- |
| Gateway (client) | Core's server cert    | Trust chain → Root CA, SAN contains expected `holomush-<game_id>` |
| Core (server)    | Gateway's client cert | Trust chain → Root CA                                             |

### Auto-generation Flow

1. On `holomush core` or `holomush gateway` start, check if certs exist
2. If not, generate:
   - Root CA: Self-signed, 10-year validity
   - Core cert: Signed by CA, 1-year validity, SAN includes game_id
   - Gateway cert: Signed by CA, 1-year validity
3. Log: `"Generated self-signed TLS certificates in $XDG_CONFIG_HOME/holomush/certs/"`

### Game ID

- Generated on first database initialization (ULID)
- Stored in `holomush_system_info` table
- Included in Core certificate SAN: `DNS:holomush-<game_id>`
- Gateway reads expected game_id from config file (no database access)

```sql
CREATE TABLE holomush_system_info (
    key         TEXT PRIMARY KEY,
    value       TEXT NOT NULL,
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    updated_at  TIMESTAMPTZ DEFAULT NOW()
);

-- Seed on first run:
INSERT INTO holomush_system_info (key, value) VALUES
    ('game_id', '01JQXYZ...'),
    ('game_name', 'holomush'),
    ('schema_version', '1');
```

### Override Flags

- `--tls-cert` / `--tls-key` - Use custom certificates
- `--tls-ca` - Custom CA for verification
- `--tls-skip-verify` - Disable verification (development only, logs warning)

## Structured Logging

### Format

All logs MUST be structured JSON by default. Include trace context when available.

```json
{
  "time": "2026-01-17T14:32:01.123Z",
  "level": "INFO",
  "msg": "handling command",
  "service": "core",
  "version": "1.0.0",
  "request_id": "01JQXYZ...",
  "session_id": "01JQABC...",
  "command": "say hello",
  "trace_id": "4bf92f3577b34da6a3ce929d0e0e4736",
  "span_id": "00f067aa0ba902b7"
}
```

### Implementation

- Custom slog handler extracts trace context from `context.Context`
- Automatically injects `trace_id` and `span_id` when present
- Falls back to empty strings when no trace context (e.g., startup logs)
- `--log-format=text` for human-readable development output

### Standard Fields

All log entries include:

| Field      | Description                          |
| ---------- | ------------------------------------ |
| `time`     | ISO8601 timestamp                    |
| `level`    | Log level (DEBUG, INFO, WARN, ERROR) |
| `msg`      | Log message                          |
| `service`  | `gateway` or `core`                  |
| `version`  | Binary version                       |
| `trace_id` | OpenTelemetry trace ID (if present)  |
| `span_id`  | OpenTelemetry span ID (if present)   |

## Control Socket

Each process exposes a management endpoint for lifecycle and health.

### Endpoints

| Endpoint    | Method | Description                    |
| ----------- | ------ | ------------------------------ |
| `/health`   | GET    | Health check (200 OK or 503)   |
| `/ready`    | GET    | Readiness check                |
| `/metrics`  | GET    | Prometheus metrics (future)    |
| `/shutdown` | POST   | Graceful shutdown              |
| `/reload`   | POST   | Hot-reload (core only, future) |

### Implementation

- Unix socket at `$XDG_RUNTIME_DIR/holomush/{core,gateway}.sock`
- Simple HTTP server on the socket
- CLI commands (`stop`, `status`, etc.) connect to control socket

## Testing Strategy

### Unit Tests

| Component           | Tests                                             |
| ------------------- | ------------------------------------------------- |
| CLI (Cobra)         | Command parsing, flag validation, help output     |
| TLS cert generation | CA creation, cert signing, SAN validation         |
| gRPC client         | Connection, reconnection on core restart          |
| gRPC server         | Request handling, streaming, auth                 |
| Logging             | JSON format, text format, trace context injection |
| XDG path resolution | Env var precedence, defaults, fallbacks           |

### Integration Tests

| Scenario                 | Verification                                       |
| ------------------------ | -------------------------------------------------- |
| Gateway + Core startup   | Both processes start, connect via gRPC             |
| Core restart tolerance   | Gateway stays up, reconnects after core restart    |
| mTLS validation          | Reject invalid certs, accept valid certs           |
| SAN mismatch rejection   | Gateway rejects core with wrong game_id in SAN     |
| Command flow             | Telnet client → Gateway → Core → response back     |
| Event streaming          | Core broadcasts event, Gateway receives via stream |
| Control socket lifecycle | `stop`, `restart`, `status` commands work          |
| Log format switching     | `--log-format=json` vs `--log-format=text`         |

### Test Infrastructure

| Tool                 | Use Case                                                        |
| -------------------- | --------------------------------------------------------------- |
| testcontainers       | PostgreSQL for Core integration tests                           |
| In-process gRPC      | Fast unit tests, real client/server in same process             |
| Wiremock / gRPC mock | Gateway isolation tests, simulate Core failures/timeouts/errors |
| Ephemeral certs      | Fresh TLS certs per test run                                    |
| Mock OTLP collector  | Trace export verification                                       |

### Coverage Target

> 80% on new code

## Documentation Updates

### Files to Update

| File                                      | Changes                                                          |
| ----------------------------------------- | ---------------------------------------------------------------- |
| `README.md`                               | New CLI commands, two-process architecture, startup instructions |
| `docs/reference/getting-started.md`       | Updated setup guide, running gateway + core                      |
| `docs/reference/architecture-overview.md` | Process separation diagram, gRPC interface                       |

### New Documentation

| File                              | Content                                                     |
| --------------------------------- | ----------------------------------------------------------- |
| `docs/reference/cli.md`           | Full CLI reference with all commands and flags              |
| `docs/reference/deployment.md`    | Running in production, systemd units, logging configuration |
| `docs/reference/observability.md` | OpenTelemetry setup, log aggregation, tracing               |

## New Dependencies

| Dependency                                                                    | Purpose           |
| ----------------------------------------------------------------------------- | ----------------- |
| `github.com/spf13/cobra`                                                      | CLI framework     |
| `google.golang.org/grpc`                                                      | gRPC              |
| `google.golang.org/protobuf`                                                  | Protocol buffers  |
| `go.opentelemetry.io/otel`                                                    | Tracing           |
| `go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc` | gRPC interceptors |

## Breaking Changes

- Single `holomush` command replaced with `holomush gateway` + `holomush core`
- Must run both processes to have functional server
- Environment variable `TELNET_ADDR` replaced with `--telnet-addr` flag

## Migration Notes

### From Phase 1

1. Build new binary with Cobra CLI
2. Run `holomush core` first (initializes database, generates certs)
3. Run `holomush gateway` second (connects to core)
4. Update any scripts/systemd units to start both processes

### Recommended Systemd Setup (Future)

```ini
# holomush-core.service
[Service]
ExecStart=/usr/bin/holomush core --database-url=...
ExecStop=/usr/bin/holomush core stop

# holomush-gateway.service
[Service]
ExecStart=/usr/bin/holomush gateway
ExecStop=/usr/bin/holomush gateway stop
Requires=holomush-core.service
After=holomush-core.service
```
