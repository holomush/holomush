# SPDX-License-Identifier: Apache-2.0
# Copyright 2026 HoloMUSH Contributors

name: Release

on:
  push:
    branches: [main]
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write # Required for Cosign keyless signing
  attestations: write # Required for provenance attestations

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@c3fc4de07084f75a2b61a5b933069bda6edf3d5c # v4.4.0
        id: release
        with:
          release-type: go

  goreleaser:
    name: Build, Sign, and Release
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created || startsWith(github.ref, 'refs/tags/')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Set up Go
        uses: actions/setup-go@f111f3307d8850f501ac008e886eec1fd1932a34 # v5.3.0
        with:
          go-version-file: go.mod

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2

      # GoReleaser handles building, signing, and releasing atomically.
      # Signing happens BEFORE artifacts are published - releases are never
      # published with unsigned artifacts.
      - name: Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Verify signing artifacts were created (defense-in-depth)
      - name: Verify signing artifacts exist
        run: |
          set -euo pipefail
          echo "Verifying signing artifacts..."

          # Check that checksums signature and certificate exist
          if [[ ! -f dist/checksums.txt.sig ]]; then
            echo "ERROR: checksums.txt.sig not found - signing may have failed"
            ls -la dist/
            exit 1
          fi

          if [[ ! -f dist/checksums.txt.sig.cert ]]; then
            echo "ERROR: checksums.txt.sig.cert not found - signing may have failed"
            ls -la dist/
            exit 1
          fi

          echo "✓ Signing artifacts verified:"
          ls -la dist/checksums.txt.sig*

      # Upload artifacts for provenance attestation
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/*.tar.gz
          retention-days: 1
          if-no-files-found: error

  # Provenance attestation runs after goreleaser completes.
  # This adds SLSA provenance to the already-signed artifacts.
  attest-provenance:
    name: Attest Provenance
    runs-on: ubuntu-latest
    needs: goreleaser
    permissions:
      id-token: write
      attestations: write
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: release-artifacts
          path: dist

      - name: Verify artifacts exist
        run: |
          set -euo pipefail
          count=$(find dist -name '*.tar.gz' -type f | wc -l)
          if [[ $count -eq 0 ]]; then
            echo "ERROR: No release artifacts found"
            exit 1
          fi
          echo "Found ${count} artifacts to attest"
          ls -la dist/

      - name: Attest binary provenance
        uses: actions/attest-build-provenance@520d128f165991a6c774bcb264afcce321339c25 # v2.2.0
        with:
          subject-path: "dist/*.tar.gz"

  # Attest container images for provenance
  attest-containers:
    name: Attest Container Provenance
    runs-on: ubuntu-latest
    needs: goreleaser
    permissions:
      id-token: write
      attestations: write
      packages: write
    steps:
      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image digest
        id: digest
        run: |
          set -euo pipefail
          VERSION="${{ needs.goreleaser.outputs.version }}"
          IMAGE="ghcr.io/holomush/holomush:${VERSION}"

          echo "Fetching digest for ${IMAGE}"
          MANIFEST_STDERR=$(mktemp)
          if ! docker manifest inspect "${IMAGE}" --verbose > /tmp/manifest.json 2> "${MANIFEST_STDERR}"; then
            echo "ERROR: Failed to inspect manifest for ${IMAGE}"
            echo "Docker manifest inspect stderr:"
            cat "${MANIFEST_STDERR}"
            exit 1
          fi

          DIGEST=$(jq -r '.Descriptor.digest // .digest' /tmp/manifest.json | head -1)

          if [[ -z "${DIGEST}" || "${DIGEST}" == "null" ]]; then
            echo "ERROR: Could not extract digest from manifest"
            echo "Manifest output:"
            cat /tmp/manifest.json
            exit 1
          fi

          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "Image digest: ${DIGEST}"

      - name: Attest container provenance
        uses: actions/attest-build-provenance@520d128f165991a6c774bcb264afcce321339c25 # v2.2.0
        with:
          subject-name: ghcr.io/holomush/holomush
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: true

  # Final verification step - ensures all signing and attestation succeeded
  verify-release:
    name: Verify Release
    runs-on: ubuntu-latest
    needs: [goreleaser, attest-provenance, attest-containers]
    permissions:
      contents: read
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@f713795cb21599bc4e5c4b58cbad1da852d7eeb9 # v3.8.2

      - name: Verify checksums signature
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.goreleaser.outputs.version }}"

          echo "Verifying release ${VERSION}..."

          # Wait for release to be available (handles propagation delay)
          for i in {1..5}; do
            if gh release view "${VERSION}" -R holomush/holomush > /dev/null 2>&1; then
              break
            fi
            echo "Release not yet available, waiting... (attempt $i/5)"
            sleep 10
          done

          # Download checksums and signature
          mkdir -p dist
          if ! gh release download "${VERSION}" -R holomush/holomush -D dist \
            -p 'checksums.txt' -p 'checksums.txt.sig' -p 'checksums.txt.sig.cert'; then
            echo "ERROR: Failed to download release artifacts"
            echo "This may indicate the release was not published or signing failed"
            gh release view "${VERSION}" -R holomush/holomush --json assets || true
            exit 1
          fi

          # Verify signature
          cosign verify-blob \
            --certificate dist/checksums.txt.sig.cert \
            --signature dist/checksums.txt.sig \
            --certificate-identity-regexp "https://github.com/holomush/holomush/.*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            dist/checksums.txt

          echo "✓ Checksums signature verified"

      - name: Verify container signature
        run: |
          set -euo pipefail
          VERSION="${{ needs.goreleaser.outputs.version }}"

          cosign verify \
            --certificate-identity-regexp "https://github.com/holomush/holomush/.*" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "ghcr.io/holomush/holomush:${VERSION}"

          echo "✓ Container signature verified"

      - name: Release verification complete
        run: |-
          echo "✓ All release artifacts are properly signed and attested"
          echo "  - Binary checksums: signed with Cosign"
          echo "  - Container images: signed with Cosign"
          echo "  - Binary provenance: attested"
          echo "  - Container provenance: attested"
